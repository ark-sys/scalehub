---
- name: Retrieve values from scalehub configuration file
  tags: [ always ]
  block:
    - name: Set path to configuration file
      set_fact:
        config_path: "{{ lookup('env','SHUB_CONFIG') }}"
    - name: Read configuration file from SHUB_CONFIG path
      set_fact:
        config_content: "{{ lookup('file', config_path) }}"
    - name: Extract flink vars
      set_fact:
        checkpoint_interval: "{{ config_content | regex_findall('flink.checkpoint_interval_ms = (\\d+)') | first }}"
        window_size: "{{ config_content | regex_findall('flink.window_size_ms = (\\d+)') | first }}"

- name: Deploy Flink
  tags: [ create ]
  block:
    - name: Pre-pull image on nodes for faster rescale operation
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('ansible.builtin.template', 'flink-prepull-daemon.yaml.j2') | from_yaml }}"

    - name: Deploy services
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('ansible.builtin.file', item) | from_yaml }}"
      with_fileglob:
        - "../files/*.yaml"

    - name: Deploy jobmanager
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('ansible.builtin.template', 'jobmanager-deployment.yaml.j2') | from_yaml }}"

    - name: Deploy taskmanager
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('ansible.builtin.template', 'taskmanager-deployment.yaml.j2') | from_yaml }}"


- name: Delete Flink
  tags: [ delete ]
  block:
    - name: Delete services
      kubernetes.core.k8s:
        state: absent
        definition: "{{ lookup('ansible.builtin.file', item) | from_yaml }}"
      with_fileglob:
        - "../files/*.yaml"

    - name: Delete jobmanager
      kubernetes.core.k8s:
        state: absent
        definition: "{{ lookup('ansible.builtin.template', 'jobmanager-deployment.yaml.j2') | from_yaml }}"

    - name: Delete taskmanager
      kubernetes.core.k8s:
        state: absent
        definition: "{{ lookup('ansible.builtin.template', 'taskmanager-deployment.yaml.j2') | from_yaml }}"

    - name: Delete pre-pull daemon-set
      kubernetes.core.k8s:
        state: absent
        definition: "{{ lookup('ansible.builtin.template', 'flink-prepull-daemon.yaml.j2') | from_yaml }}"
